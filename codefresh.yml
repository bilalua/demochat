version: '1.0'
steps:

  build-step:
     type: build
     dockerfile: Dockerfile
     image-name: containers101/demochat
     tag: ${{CF_BRANCH}}

  unit-tests:
      image: ${{build-step}}
      fail-fast: false
      commands:
        - npm test
        - echo $(date)

  integration-tests:
    type: composition
    fail-fast: false
    composition:
      version: '2'
      services:
        aut:
          image: ${{build-step}}
          ports:
            - 5000
        mongo:
          image: mongo
    composition-candidates:
      test:
        image: razielt/taurus:master
        command: bach -c "bzt letschat.yml -report -o modules.blazemeter.token=$BLAZE_TOKEN -o modules.blazemeter.test=letschat"

  demo-chat compositon:
      type: composition
      composition:
        version: '2'
        services:
         app:
           image: ${{build-step}}
           mem_limit: 150000000
           links:
             - mongo
           ports:
             - 5000
         mongo:
           image: 'mongo:latest'
           mem_limit: 150000000
           command: mongod --smallfiles
      composition-candidates:
        main:
          image: nhoag/curl
          command: bash -c "sleep 20 && curl http://app:5000/" | echo 'works'

  launch demochat:
    type: launch-composition
    environmentName: 'ENV-DEMO-CHAT'
    composition:
      version: '2'
      services:
        aut:
          image: ${{build-step}}
          ports:
            - 5000
        mongo:
          image: mongo
